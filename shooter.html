


<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <script src="shooter-res/js/virtualjoystick.js"></script>
    <style>
        #joystick {
            overflow: hidden;
            -webkit-user-select	: none;
            -moz-user-select	: none;
        }

    </style>


    <script src="https://www.gstatic.com/firebasejs/5.5.5/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyDeKkt0TEmQzbigiTpHWnL-9me_EmBzVqk",
            authDomain: "fir-shooter.firebaseapp.com",
            databaseURL: "https://fir-shooter.firebaseio.com",
            projectId: "fir-shooter",
            storageBucket: "fir-shooter.appspot.com",
            messagingSenderId: "957544258494"
        };
        firebase.initializeApp(config);
        var database = firebase.database();
        var roomRef = firebase.database().ref().child("Room");
    </script>
</head>

<body onload="init()">
    
    <div style="height: 90vh; background-color: #f6f6f6; position: absolute;" id="joystickM"></div>
    <div class="container text-center">
        <h1 id="conText" style="margin-top: 50px; display: none;"></h1>
    </div>
    
    <!--
    <div id="joystick" style="display: inline-block; position: relative; border: 1px solid blue; width: 400px; height: 600px;"></div>
    -->
    <center>
    <canvas id="canvas" width="1000px" height="600px" style="border: 1px solid black;"></canvas>
    </center>
    <script>
        function init() {
            var isMobile = false; //initiate as false
            // device detection
            if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)
                || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0, 4))) {
                isMobile = true;
            }

            if (!isMobile) {

                var joystick;
                var keys = {};

                function Enemy() {
                    this.objects = [];
                    this.maxID = 0;

                    this.init = function(enemy) {
                        enemy.scale = 1;
                        enemy.scaleD = 0;
                        var id = -1;
                        //Search empty space
                        while(this.objects[++id] != undefined);
                        this.objects[id] = enemy;
                        if(id > this.maxID) this.maxID = id;
                    }

                    this.moveToPlayer = function(obj) {
                        if (player.dead) return;
                        var xToP = player.x - obj.x;
                        var yToP = player.y - obj.y;
                        var hyp = Math.sqrt(xToP * xToP + yToP * yToP);
                        var dx = xToP * obj.v / hyp;
                        var dy = yToP * obj.v / hyp;

                        obj.x += dx;
                        obj.y += dy;
                    },

                        this.update = function() {
                            for(var i = 0;i <= this.maxID;i++){
                                if(this.objects[i] == undefined) continue;

                                var obj = this.objects[i];



                                if (obj.health > 0) {
                                    var info = bullets.getMinInfo(obj);

                                    if(info.dist <= 50 * obj.scale){
                                        info.object.remove = true;
                                        obj.health--;
                                    }
                                }

                                if (obj.health <= 0) {
                                    obj.opacity = (Math.floor(obj.opacity*100)-2)/100;
                                    obj.scaleD += 0.2;
                                    if (obj.opacity <= 0) {
                                        delete this.objects[i];
                                    }
                                } else {
                                    this.moveToPlayer(obj);
                                }
                                drawCircle(obj.x, obj.y, 25+obj.scaleD, "blue", obj.opacity);

                            }
                        }


                }

                function Bullets(){
                    this.objects = [];
                    this.maxID = 0;

                    this.init = function(bullet, rX, rY){
                        bullet.vx = bullet.v * rX;
                        //Math.cos(bullet.angle);
                        bullet.vy = bullet.v *rY;
                        //Math.sin(bullet.angle);
                    };
                    this.push = function(bullet, rX, rY){

                        this.init(bullet, rX, rY);

                        var id = -1;
                        //Search empty space
                        while(this.objects[++id] != undefined);
                        this.objects[id] = bullet;
                        if(id > this.maxID) this.maxID = id;

                    };

                    this.update = function(){
                        for(var i = 0;i <= this.maxID;i++){
                            if(this.objects[i] == undefined) continue;

                            var obj = this.objects[i];

                            obj.x += obj.vx;
                            obj.y += obj.vy;
                            //Detect if on screen
                            if(
                                obj.x < 0 || obj.y < 0 ||
                                obj.x > canvas.width || obj.y > canvas.height ||
                                obj.remove)
                                delete this.objects[i];
                            else {
                                drawCircle(obj.x, obj.y, 2, "black", 1);
                            }
                        }
                    };

                    this.getSize = function(){
                        var size = 0;
                        for(var i = 0;i <= this.maxID;i++){
                            if(this.objects[i] == undefined) continue;
                            size++;
                        }
                        return size;
                    };

                    this.getMinInfo = function(o){
                        var dist = 99999;
                        var obj;
                        for(var i = 0;i <= this.maxID;i++){
                            if(this.objects[i] == undefined) continue;
                            var d = Math.sqrt(
                                (o.x - this.objects[i].x)*(o.x - this.objects[i].x)+
                                (o.y - this.objects[i].y)*(o.y - this.objects[i].y)
                            );
                            if(d < dist){
                                dist = d;
                                obj = this.objects[i];
                            }
                        }
                        return {dist:dist,object:obj};
                    };

                }

                var bullets = new Bullets();
                var enemies = new Enemy();

                var player = {
                    w : 15,
                    h : 15,
                    x : 200,
                    y : 200,
                    velx : 0,
                    vely : 0,
                    tToAcc: 2,
                    dx : 0,
                    dy : 0,
                    shotTime : 0,
                    shotCoolDown : 20,
                    scale : 0,
                    opacity : 1,
                    dead : false,

                    checkCollision : function() {
                        //check world bounds
                        if (this.x + this.w > canvas.width) {
                            this.x = canvas.width-this.w;
                        } else if (this.x - this.w < 0) {
                            this.x = this.w;
                        }

                        if (this.y + this.h > canvas.height) {
                            this.y = canvas.height - this.h;
                        } else if (this.y - this.h < 0) {
                            this.y = this.h;
                        }

                    },

                    die : function() {
                        if (player.opacity <= 0) {
                            player.opacity = 0;
                        } else {
                            player.scale += 0.5;
                            player.opacity = (Math.floor(player.opacity*100)-1)/100;
                        }
                    },

                    render : function() {
                        drawCircle(player.x, player.y, player.w+player.scale, "red", player.opacity);
                    },

                    updateV : function(callback) {
                        /*
                        this.dx = joystick.deltaX();
                        this.dy = joystick.deltaY();
                        callback && callback();
                        */

                        database.ref().child("Room/"+roomid+"/Players/Player1").once("value").then((p1) => {
                            var c = 0;
                            p1.forEach((d) => {
                                c++;
                                if (d.key == "dx") {
                                    this.dx = d.val();
                                } else if (d.key == "dy") {
                                    this.dy = d.val();
                                }

                                if (c == 2) callback && callback();
                            });
                        });

                    },

                    checkShoot : function() {
                        var jx = 0, jy = 0;
                        database.ref().child("Room/"+roomid+"/Players/Player2").once("value").then((p2) => {
                            var c = 0;
                            p2.forEach((dir) => {
                                c++;
                                if (dir.key == "dx") {
                                    jx = dir.val();
                                } else if (dir.key == "dy") {
                                    jy = dir.val();
                                }

                                if (c == 2) {
                                    var hyp = Math.sqrt(jx*jx + jy*jy);

                                    if (hyp != 0 && this.shotTime >= this.shotCoolDown) {
                                        this.shotTime = 0;
                                        bullets.push({
                                            x:this.x,
                                            y:this.y,
                                            angle:0, //in radians
                                            v:4
                                        }, (jx / hyp), jy/hyp);
                                    }
                                    this.shotTime++;
                                }
                            });

                        });


                    },

                    update : function() {
                        if (player.dead) {
                            player.die();
                            return;
                        }
                        /*

                        if (keys[87]) {
                            //W
                            if (player.vely > -speed) {
                                player.vely--;
                            } else {
                                player.vely = -speed;
                            }
                        }

                        if (keys[83]) {
                            //S
                            if (player.vely < speed) {
                                player.vely++;
                            } else {
                                player.vely = speed;
                            }
                        }

                        if (keys[65]) {
                            //A
                            if (player.velx > -speed) {
                                player.velx--;
                            } else {
                                player.velx = -speed;
                            }
                        }

                        if (keys[68]) {
                            //D
                            if (player.velx < speed) {
                                player.velx++;
                            } else {
                                player.velx = speed;
                            }
                        }

                        */

                        this.checkShoot();

                        this.updateV(() => {
                            var maxXSpeed = Math.abs(this.dx) /jRadius * speed;
                            var maxYSpeed = Math.abs(this.dy) / jRadius * speed;
                            var accX = maxXSpeed / this.tToAcc;
                            var accY = maxYSpeed / this.tToAcc;

                            if (this.dx > 0) {
                                this.velx += accX;
                                if (this.velx > maxXSpeed) {
                                    this.velx = maxXSpeed;
                                }
                            } else {
                                this.velx -= accX;
                                if (this.velx < -maxXSpeed){
                                    this.velx = -maxXSpeed;
                                }
                            }

                            if (this.dy < 0) {
                                this.vely -= accY;
                                if (this.vely < -maxYSpeed) this.vely = -maxYSpeed;
                            } else {
                                this.vely += accY;
                                if (this.vely > maxYSpeed) this.vely = maxYSpeed;
                            }


                            player.velx *= friction;
                            player.vely *= friction;
                            player.x += player.velx;
                            player.y += player.vely;

                            this.checkCollision();
                        });


                    }
                };


                var speed = 3.5;
                var friction = 0.9;
                var jRadius = 100;

                var canvas;
                var context;
                var requestid = "";

                var roomid = "2222";
                var gamestart = false;
                var numCurrPlayers = 0;

                function initGame() {
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    /*joystick = new VirtualJoystick({
                        container	: document.getElementById('joystick'),
                        mouseSupport	: true,
                        limitStickTravel: true,
                        stickRadius	: jRadius
                    });
                    */
                    //console.log("touchscreen is", VirtualJoystick.touchScreenAvailable() ? "available" : "not available");
                    /*
                    enemies.init({
                        x:50,
                        y:50,
                        v:1,
                        opacity: 1,
                        health: 3
                    });
                    */
                    update();
                }

                function setup() {
                    canvas = document.getElementById("canvas");
                    context = canvas.getContext("2d");


                    document.addEventListener("keydown", keydown);
                    document.addEventListener("keyup", keyup);

                    context.fillStyle = "black";
                    context.font = "30px Arial";
                    //context.fillText("Press [SPACE] to begin.", 70, 200);
                    context.fillText("Room code: " + roomid, 70, 300);
                    context.fillText("Players connected: " + numCurrPlayers+" / 2", 70, 400);

                }


                function restart() {
                    gamestart = false;
                    window.cancelAnimationFrame(requestid);

                    context.clearRect(0, 0, canvas.width, canvas.height);
                    context.fillStyle = "black";
                    context.font = "30px Arial";
                    context.fillText("Press [SPACE] to begin.", 70, 200);
                    context.fillText("Room code: " + roomid, 70, 300);
                    context.fillText("Players connected: "+numCurrPlayers+" / 2", 70, 400);
                }

                var addedPlayer = function(ds) {
                    if (ds != null && ds.key == "Players") {
                        ds.ref.on("child_added", function() {
                            numCurrPlayers++;
                            if (numCurrPlayers == 2) {
                                context.fillText("Press [SPACE] to begin.", 70, 200);
                            }
                            context.clearRect(0, 300, canvas.width, canvas.height);
                            context.fillText("Players connected: " + numCurrPlayers + " / 2", 70, 400);
                        });
                    }
                };

                database.ref().child("Room/" + roomid).on("child_added", addedPlayer);


                function keydown(e) {
                    keys[e.keyCode] = true;
                    if (keys[32] && !gamestart && numCurrPlayers == 2) {
                        gamestart = !gamestart;
                        initGame();
                    }

                    if (keys[69]) {
                        restart();
                    }
                }

                function keyup(e) {
                    keys[e.keyCode] = false;
                }

                function update() {
                    context.clearRect(0, 0, canvas.width, canvas.height);


                    /*
                    var updates = {};
                    updates["Room/" + roomid + "/Player2/dx"] = Math.floor(joystick.deltaX());
                    updates["Room/" + roomid + "/Player2/dy"] = Math.floor(joystick.deltaY());
                    database.ref().update(updates);
                    */

                    player.update();
                    bullets.update();
                    enemies.update();

                    player.render();
                    requestid = window.requestAnimationFrame(update);
                }


                function drawCircle(x, y, r, color, opacity) {
                    context.globalAlpha = opacity;
                    context.beginPath();
                    context.arc(x, y, r, 0, 2 * Math.PI, false);
                    context.fillStyle = color;
                    context.fill();
                    context.globalAlpha = 1;
                }

                //initGame();
                setup();
            } else {
                document.getElementById("canvas").style.display = "none";

                var roomRefM ="";
                var roomid = "";

                function setup() {
                    var roomID = prompt("Enter room code:");
                    if (roomID.length != 4) {
                        alert("Code must be four characters.");
                        setup();
                    }
                    database.ref().once("value").then(function(ds) {
                        var connectedRoom = false;

                        roomRef.ref.once("value").then(function(roomP) {
                            numRooms = roomP.numChildren();
                            var c = 0;
                            roomP.forEach(function(rooms) {
                                //console.log(numRooms + " "+ rooms.key);
                                c++;
                                if (rooms.key == roomID) {
                                    roomid = roomID;
                                    roomRefM = rooms.ref;
                                    if (rooms.hasChild("Players")) {
                                        rooms.forEach(function(roomContent) {
                                            if (roomContent.key == "Players") {
                                                if (roomContent.numChildren() == 2) {
                                                    alert("Room currently full");
                                                    setup();
                                                } else if (rooms.child("GameStart").val() == true) {
                                                    alert("Game already started. Please choose another game.");
                                                    setup();
                                                } else {
                                                    connectedRoom = true;
                                                    console.log("connected");
                                                    initMobile();
                                                }
                                            }
                                        });


                                    } else {
                                        connectedRoom = true;
                                        console.log("connected");
                                        initMobile();

                                    }
                                } else if (!connectedRoom && c == numRooms) {
                                    alert("Room code doesn't exist.");
                                    setup();
                                }
                            });
                        });
                    });

                }


                setup();

                var playerNum = 1;
                var totalPlayers = 0;
                var jRadius = 200;
                var joystick;

                function initMobile() {

                    joystick = new VirtualJoystick({
                        container	: document.getElementById('joystickM'),
                        mouseSupport	: true,
                        limitStickTravel: true,
                        stickRadius	: jRadius
                    });

                    function trackMovement() {
                        if (playerNum == 1) {
                            var updates = {};
                            updates["Room/" + roomid + "/Players/Player1/dx"] = Math.floor(joystick.deltaX());
                            updates["Room/" + roomid + "/Players/Player1/dy"] = Math.floor(joystick.deltaY());
                            database.ref().update(updates);
                        } else if (playerNum == 2) {
                            var updates = {};
                            updates["Room/" + roomid + "/Players/Player2/dx"] = Math.floor(joystick.deltaX());
                            updates["Room/" + roomid + "/Players/Player2/dy"] = Math.floor(joystick.deltaY());
                            database.ref().update(updates);
                        }
                        requestAnimationFrame(trackMovement);
                    }

                    var startGame = function(ds) {
                        if (ds != null && ds.val() == true) {
                            trackMovement();
                        }
                    };

                    roomRefM.child("GameStart").on("value", startGame);

                    roomRefM.child("Players").ref.once("value").then(function(players) {
                        var nPlayers = players.numChildren();

                        if (nPlayers == 0) {
                            playerNum = 1;
                            var updates = {};
                            updates['/Room/' + roomid + '/Players/Player1/dx'] = 0;
                            updates['/Room/' + roomid + '/Players/Player1/dy'] = 0;
                            database.ref().update(updates);
                        } else if (nPlayers == 1) {
                            playerNum = 2;
                            var updates = {};
                            updates['/Room/' + roomid + '/Players/Player2/dx'] = 0;
                            updates['/Room/' + roomid + '/Players/Player2/dy'] = 0;
                            database.ref().update(updates);
                        }
                        document.getElementById("conText").style.display = "block";
                        document.getElementById("conText").innerHTML = "Connected P" + playerNum + "<br>JoyStick Enabled";
                        console.log(playerNum);
                    });

                }

            }
        }


     // https://github.com/jeromeetienne/virtualjoystick.js
    </script>
    
    

</body>
</html>