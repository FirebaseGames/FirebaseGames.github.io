<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>



<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <script src="shooter-res/js/virtualjoystick.js"></script>
      <link rel='stylesheet prefetch' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css'>

    <link rel="stylesheet" href="shooter-res/radial-button.css">
    <style>
       

    </style>



</head>

<body onload="">



    
    
<div id="canvasD" style="width:100%; height:100%;">
    <div id="initPlayers" style="display: none">
        <!--
        <button onclick="addPlayer(1)">Player1</button>
        <button onclick="addPlayer(2)">Player2</button>
        <button onclick="addPlayer(3)">Player3</button>
        <button onclick="addPlayer(4)">Player4</button>
        -->
        <div class="menu">
          <div class="btn trigger">
            <span class="line"></span>
          </div>
          <div class="icons">

            <div class="rotater" onclick="addPlayer(1)">
              <div class="btn btn-icon">
                <i class="fa" style="font-family: sans-serif">P1</i>
              </div>
            </div>
            <div class="rotater" onclick="addPlayer(2)">
              <div class="btn btn-icon">
                <i class="fa" style="font-family: sans-serif">P2</i>
              </div>
            </div>

            <div class="rotater" onclick="addPlayer(4)">
              <div class="btn btn-icon">
                <i class="fa" style="font-family: sans-serif">P4</i>
              </div>
            </div>
            <div class="rotater" onclick="addPlayer(3)">
              <div class="btn btn-icon">
                <i class="fa" style="font-family: sans-serif">P3</i>
              </div>
            </div>
          </div>
        </div>
        
        
    </div>
    <center><br><br>
            <h1 style="color:red;" id="messageM"></h1>
        </center>
<center>
    <canvas id="canvas" width="1200px" height="500px" style="border: 1px solid black;"></canvas>
</center>
</div>

<br>
      <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

    <script src="shooter-res/radial-button.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.5.5/firebase.js"></script>

<script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyDeKkt0TEmQzbigiTpHWnL-9me_EmBzVqk",
        authDomain: "fir-shooter.firebaseapp.com",
        databaseURL: "https://fir-shooter.firebaseio.com",
        projectId: "fir-shooter",
        storageBucket: "fir-shooter.appspot.com",
        messagingSenderId: "957544258494"
    };
    firebase.initializeApp(config);
    var database = firebase.database();
    var roomRef = firebase.database().ref().child("PVP-Room");
</script>
    
<script src="shooter-res/js/pvp_bullets.js"></script>
<script src="shooter-res/js/pvp-player.js"></script>
<script src="shooter-res/js/util.js"></script>
<script src="shooter-res/js/wall.js"></script>


<script>
            var isMobile = false;
            if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)
                || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0, 4))) {
                isMobile = true;
            }
            if (!isMobile) {
    
                var keys = {};

                var bullets = new Bullets();
                var wall = new Wall();

                var tapedTwice = false;

                var roomidPVP = "1111";
                var numPlayers = 0;
                var displayStartScreen = true;
                var playersSS = 0;

                function initGame() {



                    /*
                    if (checkMobile()) {var ratio = window.devicePixelRatio || 1;
                        var w = Math.min(screen.width, screen.height) * ratio;
                        var h = Math.max(screen.height, screen.width) * ratio;
                        document.getElementById("canvas").setAttribute("width", "" + h * 0.7 + "px");
                        document.getElementById("canvas").setAttribute("height", "" + w * 0.69 + "px");
                        document.getElementById("controls").style.display = "none";
                        setupMobile();
                    } else {
                    */
                        document.getElementById("canvas").setAttribute("width", ""+screen.width*0.9+"px");
                        document.getElementById("canvas").setAttribute("height", ""+screen.height*0.6+"px");
                        player2.x = screen.width*0.9-50;
                    //}
                    canvas = document.getElementById("canvas");
                    context = canvas.getContext("2d");

                    document.addEventListener("keydown", keydown);
                    document.addEventListener("keyup", keyup);

                    context.clearRect(0, 0, canvas.width, canvas.height);

                    update();
                }

                function resetGame() {
                    player1.reset();
                    player2.reset();
                    bullets.reset();
                }

                function keydown(e) {
                    keys[e.keyCode] = true;
                }

                function keyup(e) {
                    keys[e.keyCode] = false;
                }

                function clearB() {
                    blankTimer = 0;
                    bullets.reset();
                }

                function createRoom() {
                        var roomID = prompt("Create room code:");

                        var createdRoom = false;

                        if (roomID.length != 4) {
                            alert("Code must be four characters.");
                            createRoom();
                            return;
                        }

                        database.ref().once("value").then(function(app) {
                            numRooms = app.numChildren();
                            var updates = {};

                            roomRef.ref.once("value").then(function(appP) {
                                var c = 0;
                                appP.forEach(function(rooms) {
                                    c++;
                                    if (rooms.key == roomID) {
                                        if (roomID.length != 4) alert("Code must be four characters.");
                                        else alert("Room code already taken.");
                                        createRoom();
                                    }
                                    if (c == numRooms) {
                                        updates['/PVP-Room/' + roomID + '/GameStart'] = false;
                                        database.ref().update(updates);
                                        console.log("Created Room.");
                                        createdRoom = true;
                                        roomidPVP = roomID;
                                        initGame();
                                    }
                                });
                            });
                        });
                    }




                function update() {
                    context.clearRect(0, 0, canvas.width, canvas.height);

                    if (displayStartScreen) {
                        context.fillStyle = "black";
                        context.font = "30px Arial";
                        context.fillText("Room code: " + roomidPVP, 70, 200);
                        context.fillText("Players connected: " + playersSS+" (need 2 or more)", 70, 300);
                        if (playersSS >= 2) {
                            context.fillText("Press [SPACE] to begin.", 70, 100);
                            if (keys[32]) {
                                database.ref().child("PVP-Room/" + roomidPVP + "/GameStart").set(true);
                                numPlayers = playersSS;
                                displayStartScreen = false;
                            }
                        }
                        database.ref().child("PVP-Room/" + roomidPVP).once("value").then((ds)=>{
                            playersSS = ds.numChildren()-1;

                        });
                    } else {

                        player2.update();

                        player1.update();
                        bullets.update();
                        wall.update();


                        player1.render();
                        player2.render();

                        if (gameState == p1win) {
                            context.fillStyle = "black";
                            context.font = "bold 50px Arial";
                            context.fillText("P1 Wins!", 300, 200);
                            context.fillText("Try Again?" + ((isMobile) ? " [Double Tap]" : " [SPACE]"), 300, 350);
                        } else if (gameState == p2win) {
                            context.fillStyle = "black";
                            context.font = "bold 50px Arial";
                            context.fillText("P2 Wins!", 300, 200);
                            context.fillText("Try Again?" + ((isMobile) ? " [Double Tap]" : " [SPACE]"), 300, 350);
                        }

                        if ((gameState == p1win || gameState == p2win) && keys[32]) {
                            resetGame();
                            gameState = playing;
                        }

                    }
                    requestid = window.requestAnimationFrame(update);
                }


                function drawCircle(x, y, r, color, opacity) {
                    context.globalAlpha = opacity;
                    context.beginPath();
                    context.arc(x, y, r, 0, 2 * Math.PI, false);
                    context.fillStyle = color;
                    context.fill();
                    context.globalAlpha = 1;
                }

                //initGame();
                createRoom();

            } else {
                document.getElementById("canvas").style.display = "none";
                var joystick1, joystick2;

                var roomRefM = "";
                var playerNum = 0;
                var roomidM = "";
                var numPlayers = 0;

                function setup() {
                    var roomID = prompt("Enter room code:");

                    if (roomID.length != 4) {
                        alert("Code must be four characters.");
                        setup();
                    }
                    database.ref().once("value").then(function (ds) {
                        var connectedRoom = false;

                        roomRef.ref.once("value").then(function (roomP) {
                            numRooms = roomP.numChildren();
                            var c = 0;
                            roomP.forEach(function (rooms) {
                                //console.log(numRooms + " "+ rooms.key);
                                c++;
                                if (rooms.key == roomID) {
                                    roomidM = roomID;
                                    roomRefM = rooms.ref;
                                    if (rooms.hasChild("Players")) {
                                        rooms.forEach(function (roomContent) {
                                            if (roomContent.key == "Players") {
                                                if (roomContent.numChildren() == 4) {
                                                    alert("Room currently full");
                                                    setup();
                                                } else if (rooms.child("GameStart").val() == true) {
                                                    alert("Game already started. Please choose another game.");
                                                    setup();
                                                } else {
                                                    connectedRoom = true;
                                                    console.log("connected");
                                                    if (!mHosting) initMobile();
                                                }
                                            }
                                        });


                                    } else {
                                        connectedRoom = true;
                                        console.log("connected");
                                        if (!mHosting)initMobile();

                                    }
                                } else if (!connectedRoom && c == numRooms) {
                                    alert("Room code doesn't exist.");
                                    setup();
                                }
                            });
                        });
                    });

                }


                setup();
                //initMobile();

                function initMobile() {
                    document.getElementById("messageM").style.color = "black";
                    document.getElementById("messageM").innerHTML = "Select Player";
                    document.getElementById("initPlayers").style.display = "block";
                }

                function addPlayer(playerN) {
                    roomRefM.ref.once("value").then((ds)=>{
                        if (ds.hasChild("Player"+playerN)) {
                            console.log("Player already selected.");
                            document.getElementById("messageM").style.color = "red";
                            document.getElementById("messageM").innerHTML = "Player already selected";
                            setTimeout(()=>{
                                if (playerNum==0)
                                document.getElementById("messageM").innerHTML ="";
                            }, 1500);
                            return;
                        }


                        if (playerN == 1) {
                            playerNum = 1;
                            var updates = {};
                            updates['/PVP-Room/' + roomidM + '/Player1/Move/dx'] = 0;
                            updates['/PVP-Room/' + roomidM + '/Player1/Move/dy'] = 0;
                            database.ref().update(updates);
                            initGame();
                        } else if (playerN == 2) {
                            playerNum = 2;
                            var updates = {};
                            updates['/PVP-Room/' + roomidM + '/Player2/Move/dx'] = 0;
                            updates['/PVP-Room/' + roomidM + '/Player2/Move/dy'] = 0;
                            database.ref().update(updates);
                            initGame();
                        } else if (playerN == 3) {
                            if (!(ds.hasChild("Player1")&&ds.hasChild("Player2"))) {
                                console.log("Must select available players first.");
                                document.getElementById("messageM").style.color = "red";
                                document.getElementById("messageM").innerHTML = "Must select available players first";
                                setTimeout(()=>{
                                    if (playerNum==0)
                                    document.getElementById("messageM").innerHTML ="";
                                }, 1500);
                                return;
                            }

                            playerNum = 3;
                            var updates = {};
                            updates['/PVP-Room/' + roomidM + '/Player3/Shoot/dx'] = 0;
                            updates['/PVP-Room/' + roomidM + '/Player3/Shoot/dy'] = 0;
                            database.ref().update(updates);
                            initGame();
                        } else if (playerN == 4) {
                            if (!(ds.hasChild("Player1")&&ds.hasChild("Player2")&&ds.hasChild("Player3"))) {
                                console.log("Must select available players first.");
                                document.getElementById("messageM").style.color = "red";
                                document.getElementById("messageM").innerHTML = "Must select available players first";
                                setTimeout(()=>{
                                    if (playerNum==0)
                                    document.getElementById("messageM").innerHTML ="";
                                }, 1500);
                                return;
                            }

                            playerNum = 4;
                            var updates = {};
                            updates['/PVP-Room/' + roomidM + '/Player4/Shoot/dx'] = 0;
                            updates['/PVP-Room/' + roomidM + '/Player4/Shoot/dy'] = 0;
                            database.ref().update(updates);
                            initGame();
                        }
                    });
                }


                function initGame() {
                    document.getElementById("initPlayers").style.display = "none";
                    var ratio = window.devicePixelRatio || 1;
                    document.getElementById("canvas").setAttribute("width", ""+screen.width*ratio*0.9+"px");
                    document.getElementById("canvas").setAttribute("height", ""+screen.height*ratio*0.9+"px");
                    document.getElementById("canvas").style.border = "none";
                    setInterval(()=>{
                        var ratio = window.devicePixelRatio || 1;
                        document.getElementById("canvas").setAttribute("width", ""+screen.width*ratio*0.9+"px");
                        document.getElementById("canvas").setAttribute("height", ""+screen.height*ratio*0.9+"px");

                        if (numPlayers==2 && joystick1 != null && joystick2 != null) {
                            joystick2.addEventListener('touchStartValidation', function(event){
                                var touch	= event.changedTouches[0];
                                if( touch.pageX <= window.innerWidth/2 )	return false;
                                return true;
                            });

                            joystick1.addEventListener('touchStartValidation', function(event){
                                var touch	= event.changedTouches[0];
                                if( touch.pageX > window.innerWidth/2 )	return false;
                                return true;
                            });
                        }
                    }, 1000);


                    var startGame = function (ds) {
                        if (ds != null && ds.val() == true) {
                            setupMobile();
                        }
                    };

                    roomRefM.child("GameStart").on("value", startGame);
                    document.getElementById("messageM").style.color = "black";
                    document.getElementById("messageM").innerHTML = "Player " + playerNum + "<br>Waiting to start";
                    

                }
                
                function update() {

                    if (playerNum == 1) {
                        var updates = {};
                        updates["PVP-Room/" + roomidM + "/Player1/Move/dx"] = Math.floor(joystick1.deltaX());
                        updates["PVP-Room/" + roomidM + "/Player1/Move/dy"] = Math.floor(joystick1.deltaY());

                        if (numPlayers==2) {
                            updates["PVP-Room/" + roomidM + "/Player1/Shoot/dx"] = Math.floor(joystick2.deltaX());
                            updates["PVP-Room/" + roomidM + "/Player1/Shoot/dy"] = Math.floor(joystick2.deltaY());
                        }
                        database.ref().update(updates);
                    } else if (playerNum == 2) {
                        var updates = {};
                        updates["PVP-Room/" + roomidM + "/Player2/Move/dx"] = Math.floor(joystick1.deltaX());
                        updates["PVP-Room/" + roomidM + "/Player2/Move/dy"] = Math.floor(joystick1.deltaY());

                        if (numPlayers==2||numPlayers==3) {
                            updates["PVP-Room/" + roomidM + "/Player2/Shoot/dx"] = Math.floor(joystick2.deltaX());
                            updates["PVP-Room/" + roomidM + "/Player2/Shoot/dy"] = Math.floor(joystick2.deltaY());
                        }
                        database.ref().update(updates);
                    } else if (playerNum == 3) {
                        var updates = {};
                        updates["PVP-Room/" + roomidM + "/Player3/Shoot/dx"] = Math.floor(joystick1.deltaX());
                        updates["PVP-Room/" + roomidM + "/Player3/Shoot/dy"] = Math.floor(joystick1.deltaY());
                        database.ref().update(updates);
                    } else if (playerNum == 4) {
                        var updates = {};
                        updates["PVP-Room/" + roomidM + "/Player4/Shoot/dx"] = Math.floor(joystick1.deltaX());
                        updates["PVP-Room/" + roomidM + "/Player4/Shoot/dy"] = Math.floor(joystick1.deltaY());
                        database.ref().update(updates);
                    }

                    requestAnimationFrame(update);
                }
                
                function setupMobile() {
                    roomRefM.ref.once("value").then((ds)=>{
                        numPlayers = ds.numChildren()-1;

                        jRadius = 100;
                        joystick1	= new VirtualJoystick({
                            container	: document.getElementById('canvasD'),
                            mouseSupport	: true,
                            limitStickTravel : true,
                            strokeStyle	: 'orange',
                            stickRadius: jRadius
                        });

                        if (numPlayers==2) {
                            joystick2	= new VirtualJoystick({
                                container	: document.getElementById('canvasD'),
                                mouseSupport	: true,
                                limitStickTravel : true,
                                strokeStyle: 'blue',
                                stickRadius: jRadius
                            });

                            joystick2.addEventListener('touchStartValidation', function(event){
                                var touch	= event.changedTouches[0];
                                if( touch.pageX <= window.innerWidth/2 )	return false;
                                return true;
                            });

                            joystick1.addEventListener('touchStartValidation', function(event){
                                var touch	= event.changedTouches[0];
                                if( touch.pageX > window.innerWidth/2 )	return false;
                                return true;
                            });
                        } else if (numPlayers==3 && playerNum==2) {
                            joystick2	= new VirtualJoystick({
                                container	: document.getElementById('canvasD'),
                                mouseSupport	: true,
                                limitStickTravel : true,
                                strokeStyle: 'blue',
                                stickRadius: jRadius
                            });

                            joystick2.addEventListener('touchStartValidation', function(event){
                                var touch	= event.changedTouches[0];
                                if( touch.pageX <= window.innerWidth/2 )	return false;
                                return true;
                            });

                            joystick1.addEventListener('touchStartValidation', function(event){
                                var touch	= event.changedTouches[0];
                                if( touch.pageX > window.innerWidth/2 )	return false;
                                return true;
                            });
                        }
                        
                        document.getElementById("messageM").style.color = "black";
                        if (numPlayers==2) {
                            document.getElementById("messageM").innerHTML = "Player " + playerNum + "<br>2 Joysticks enabled<br>Left Stick - Move<br>Right Stick - Shoot";
                        } else if (numPlayers==3) {
                            if (playerNum==2) {
                                document.getElementById("messageM").innerHTML = "Player " + playerNum + "<br>2 Joysticks enabled<br>Left Stick - Move<br>Right Stick - Shoot";   
                            } else {
                                document.getElementById("messageM").innerHTML = "Player " + playerNum + "<br>Joystick enabled<br>Stick - " + ((playerNum==1)?"Move":"Shoot");
                            }
                        } else if (numPlayers==4) {
                            document.getElementById("messageM").innerHTML = "Player " + playerNum + "<br>Joystick enabled<br>Stick - " + ((playerNum<3)?"Move":"Shoot");
                        }
                        
                        
                        update();
                    });


                }
            }

    // https://github.com/jeromeetienne/virtualjoystick.js
</script>



</body>
</html>
</body>
</html>